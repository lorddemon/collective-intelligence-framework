<font color='red'>
<h1>Testing</h1>
<ul><li>Last tested on RC2<br>
</li><li>2013-08-30 - giovino<br>
<ul><li>updated required dependencies and perl modules via cpan.<br>
</li><li>need to test a full install<br>
</font></li></ul></li></ul>

# Introduction #

This doc assumes the CentOS-5.9-x86\_64-netinstall.iso was used during installation.

**Table of Contents**


# Details #

## Caveats ##

### Static Address ###
Make sure your instance has a static v4 address

### IPv6 ###
There are some weird issues with the way RHEL (and therefor CentOS) handle the ipv6 driver module, and how some perl modules react to this. If you've left the ipv6 defaults (or leverage ipv6 for routing) you'll probably be OK. If you've "disabled" ipv6, you might run into some build testing issues. If you do, try to force install the modules, gather the testing output (and your ipv6 configurations, etc) and log a bug report.

### SELINUX ###
Selinux either needs to be disabled or a [policy](http://wiki.centos.org/HowTos/SELinux) needs to be written allowing postgres r/w access to /mnt/archive and /mnt/index

  1. disable selinux
```
$ sudo vi /etc/selinux/config
```
```
# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
SELINUX=permissive
```
  1. restart the server for the kernel changes to take effect
```
$ sudo /sbin/shutdown -r now
```

## Dependencies ##

---

Depending on your environment, you may or may not wish to add 3rd party repositories to your installation. To address this, the first link has instructions if you want to add 3rd party repositories, the second is if you wish to manually download all dependencies from 3rd party repositories.

Click on the option that best fits your needs and continue.

  * [Add 3rd party repositories to install dependencies](ServerInstall_CentOS5_add_repos_v1.md)
> #### OR ####
  * [Manually download dependencies from 3rd party repositories and install](ServerInstall_CentOS5_dl_from_repos_v1.md)

## CPAN ##

---

### Configure CPAN ###

  1. become root
```
$ sudo su -
```
  1. configure CPAN for use
```
$ perl -MCPAN -e 'shell'
```
  1. choose all default options
  1. when it gets to the option to select a mirror, choost you continent, country, then an appropriate mirror
  1. when returned to the `cpan>` prompt, type `exit`

### Update CPAN ###

  1. become root
```
$ sudo su -
```
  1. update CPAN
```
$ PERL_MM_USE_DEFAULT=1 perl -MCPAN -e 'install JSON::PP,IPC::Cmd,Bundle::CPAN'
```
  1. If prompted during install, accept default values.
  1. Install (as root) the remaining CPAN modules. Note: changing the order of the packages in the above line can result in packages not building/installing correctly.
```
$ PERL_MM_USE_DEFAULT=1 perl -MCPAN -e 'install +Module::Build,Test::SharedFork,Test::TCP,Net::Abuse::Utils,Linux::Cpuinfo,Google::ProtocolBuffers,Iodef::Pb::Simple,Compress::Snappy,Net::Abuse::Utils::Spamhaus,Net::DNS,Net::DNS::Match,Snort::Rule,Parse::Range,Log::Dispatch,ZeroMQ,Sys::MemInfo,JSON::XS,File::Type,LWP::UserAgent,Class::Trigger,Class::DBI,Net::Patricia,Text::Table,Mozilla::CA,Net::SSLeay,IO::Socket::SSL,IO::Socket::INET6,Text::CSV,XML::RSS,Date::Manip,Module::Pluggable,MIME::Lite,Time::HiRes,LWP::Protocol::https,LWPx::ParanoidAgent'
```

## System Setup ##

---


### Resolve Config ###
We need to point our dns resoultion to the local nameserver instance.

  1. modify /etc/sysconfig/network-scripts/ifcfg-eth0 with the following DNS1="127.0.0.1" line
```
$ echo "DNS1=127.0.0.1" | sudo tee -a /etc/sysconfig/network-scripts/ifcfg-eth0
```
  1. restart networking
```
$ sudo /sbin/ifdown eth0 && sudo /sbin/ifup eth0
```
  1. verify resolve config
```
$ cat /etc/resolv.conf
```
Should look similar to:
```
; generated by /sbin/dhclient-script
search localdomain
nameserver 127.0.0.1
```

### PostgreSQL ###

  1. init the main cluster
```
$ sudo /sbin/service postgresql initdb
```
  1. The default installation of PostgreSQL differs with respect to the rest of the documentation. Some symlinking aligns it:
```
$ sudo mkdir -p /etc/postgresql/8.4/main
$ sudo chown -R postgres:postgres /etc/postgresql
$ sudo chmod 760 -R /etc/postgresql
$ sudo ln -sf /var/lib/pgsql/data/postgresql.conf /etc/postgresql/8.4/main/postgresql.conf
$ sudo ln -sf /var/lib/pgsql/data/pg_hba.conf /etc/postgresql/8.4/main/pg_hba.conf
```
  1. start up the cluster
```
$ sudo /sbin/service postgresql start
```

## Default CIF user ##

  1. create the default "cif" user/group
```
$ sudo /usr/sbin/useradd cif
```
  1. change the default home permissions
```
$ sudo chmod 770 /home/cif
```

## CIF Router Configuration (Apache) ##

Some of the "CIF" values will be created later in the doc. For now just follow the config as is, don't worry about creating things in /opt/cif or /home/cif

  1. if you need help generating your own certificates, follow the directions [here](http://wiki.centos.org/HowTos/Https)
  1. unless you know what you're doing with virtual hosts, comment out the port-80 stuff in /etc/httpd/conf/httpd.conf (around line 130)
```
# Listen: Allows you to bind Apache to specific IP addresses and/or
# ports, in addition to the default. See also the <VirtualHost>
# directive.
#
# Change this to Listen on specific IP addresses as shown below to
# prevent Apache from glomming onto all bound IP addresses (0.0.0.0)
#
#Listen 12.34.56.78:80
+ #Listen 80
```
  1. configure httpd, add these lines to your /etc/httpd/conf.d/ssl.conf config (around line 80)
```
<VirtualHost _default_:443>
+      PerlRequire /opt/cif/bin/http_api.pl
+      Include /etc/httpd/conf.d/cif.conf
....
```
  1. create your config at /etc/httpd/conf.d/cif.conf, which should look like:
```
<Location /api>
    SetHandler perl-script
    PerlResponseHandler CIF::Router::HTTP
    PerlSetVar CIFRouterConfig "/home/cif/.cif"
</Location>
```
  1. add your "apache" user to the group "cif" (this modifies /etc/group):
```
$ sudo /usr/sbin/usermod -a -G cif apache
```
  1. we'll restart apache later in the doc after we install the core CIF code

## Random Number Generator ##

---


The "rngd' service [helps](https://www.centos.org/modules/newbb/viewtopic.php?topic_id=36209) with random number generation (mainly used for generating security certificates in bind and apache, speeds up the entropy process).

By default, there is no rngd service script. This does exist in CentOS 6, so we'll take that one and use it.

  1. create a new file /etc/init.d/rngd
```
#!/bin/bash
#
# rngd        This starts and stops rngd
#
# chkconfig: - 13 99
# description: This starts the Random Number Generator Daemon, \
#              which collects entropy from hardware sources and \
#              write it to /dev/random
#
# processname: /sbin/rngd
# config: /etc/sysconfig/rngd
# pidfile: /var/run/rngd.pid
#
# Return values according to LSB for all commands but status:
# 0 - success
# 1 - generic or unspecified error
# 2 - invalid or excess argument(s)
# 3 - unimplemented feature (e.g. "reload")
# 4 - insufficient privilege
# 5 - program is not installed
# 6 - program is not configured
# 7 - program is not running
#


PATH=/sbin:/bin:/usr/bin:/usr/sbin
prog="rngd"

# Source function library.
. /etc/init.d/functions

# Allow anyone to run status
if [ "$1" = "status" ] ; then
	status $prog
	RETVAL=$?
	exit $RETVAL
fi

# Check that we are root ... so non-root users stop here
test $EUID = 0  ||  exit 4

# Check config
test -f /etc/sysconfig/rngd && . /etc/sysconfig/rngd

RETVAL=0

start(){
	test -x /sbin/rngd  || exit 5

	echo -n $"Starting $prog: "

	unset HOME MAIL USER USERNAME
	daemon $prog "$EXTRAOPTIONS"
	RETVAL=$?
	echo
	if test $RETVAL = 0 ; then
		touch /var/lock/subsys/rngd
	fi
	return $RETVAL
}

stop(){
	echo -n $"Stopping $prog: "
	killproc $prog
	RETVAL=$?
	echo
	rm -f /var/lock/subsys/rngd
	return $RETVAL
}

reload(){
	stop
	start
}

restart(){
	stop
	start
}

condrestart(){
	[ -e /var/lock/subsys/rngd ] && restart
	return 0
}


# See how we were called.
case "$1" in
	start)
	start
	;;
	stop)
	stop
	;;
	restart)
	restart
	;;
	reload|force-reload)
	reload
	;;
	condrestart|try-restart)
	condrestart
	;;
	*)
	echo $"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload}"
	RETVAL=3
esac

exit $RETVAL
```
  1. make the file executable
```
$ sudo chmod 755 /etc/init.d/rngd
```
  1. create the file /etc/sysconfig/rngd, and have it use /dev/urandom as the seed
```
$ echo EXTRAOPTIONS=\"-r /dev/urandom\" | sudo tee -a /etc/sysconfig/rngd
```
  1. change permissions of the file
```
$ sudo chmod 640 /etc/sysconfig/rngd
```
  1. (re)start rngd
```
$ sudo /sbin/service rngd restart
```

## Finishing Up ##
  1. enable services at startup
```
$ sudo /sbin/chkconfig --levels 345 postgresql on
$ sudo /sbin/chkconfig --levels 345 named on
$ sudo /sbin/chkconfig --levels 345 rngd on
$ sudo /sbin/chkconfig --levels 345 httpd on
```

## Continue with installation ##

---

  1. Continue with [Nameserver configuration](ServerInstall_v1#Bind.md)